;
; Play notes on buzzer connected to 8155 timer.
;

CS	EQU	20H
PORTA	EQU	21H
PORTB	EQU	22H
PORTC	EQU	23H
TMRLO	EQU	24H
TMRHI	EQU	25H

PUTC	EQU	0FA6H	; char in A
GETC	EQU	0FCAH	; char in A
KBHIT	EQU	1006H
MONITR	EQU	018AH
PUTHEX	EQU	0F40H	; char in A
PUTS	EQU	0F58H	; str in H

CLK	EQU	3686400
SYSCLK	EQU	CLK/2
C4	EQU	(SYSCLK / 262 / 256)
D4	EQU	(SYSCLK / 294 / 256)
E4	EQU	(SYSCLK / 330 / 256)
F4	EQU	(SYSCLK / 349 / 256)
G4	EQU	(SYSCLK / 392 / 256)
A4	EQU	(SYSCLK / 440 / 256)
B4	EQU	(SYSCLK / 494 / 256)

C5	EQU	(SYSCLK / 523 / 256)
D5	EQU	(SYSCLK / 587 / 256)
E5	EQU	(SYSCLK / 659 / 256)
F5	EQU	(SYSCLK / 698 / 256)
G5	EQU	(SYSCLK / 784 / 256)
A5	EQU	(SYSCLK / 880 / 256)
B5	EQU	(SYSCLK / 988 / 256)
C6	EQU	(SYSCLK / 1046 / 256)
D6	EQU	(SYSCLK / 1174 / 256)
E6	EQU	(SYSCLK / 1318 / 256)
F6	EQU	(SYSCLK / 1396 / 256)
G6	EQU	(SYSCLK / 1568 / 256)
A6	EQU	(SYSCLK / 1760 / 256)

DEL0	EQU	0FFH
DEL2	EQU	40H
DEL4	EQU	80H

	ORG	8000H
start:
	LXI	SP,0FFFFH

	LXI	H,intros
	CALL	PUTS

	CALL	noteoff

again:
	MVI	A,'X'
	CALL	PUTC
	LXI	H,notes

loop:
	MVI	A,'.'
	CALL	PUTC

	MOV	A,M
	ANA	A
	JZ	again
	INX	H

	CALL	noteon
	MOV	A,M
	INX	H
	CALL	delay
	CALL	noteoff

	CALL	KBHIT
	JZ      loop

	JMP	MONITR

intros:
	.asciz	"Playing music\r\n"

notes:
	DB	A4,DEL4,A4,DEL4,A4,DEL4,F4,DEL2,C5,DEL2
	DB	A4,DEL4,F4,DEL2,C5,DEL2,A4,DEL0
	DB	E5,DEL4,E5,DEL4,E5,DEL4,F5,DEL2,C5,DEL2
	DB	A4,DEL4,F4,DEL2,C5,DEL2,A4,DEL0

	DB	A5,DEL4,A4,DEL2,A4,DEL2,A5,DEL4,A5,DEL2,G5,DEL2
	DB	G5,DEL2,F5,DEL2,G5,DEL2,B4,DEL2,E5,DEL4,D5,DEL2,D5,DEL2

	DB	C5,DEL2,B4,DEL2,C5,DEL2,F4,DEL2,A4,DEL4,F4,DEL2,A4,DEL2
	DB	C5,DEL4,A4,DEL2,C5,DEL2,E5,DEL0

	DB	A5,DEL4,A4,DEL2,A4,DEL2,A5,DEL4,A5,DEL2,G5,DEL2
	DB	G5,DEL2,F5,DEL2,G5,DEL2,B4,DEL2,E5,DEL4,D5,DEL2,D5,DEL2
	DB	C5,DEL2,B4,DEL2,C5,DEL2,F4,DEL2,A4,DEL4,F4,DEL2,C5,DEL2
	DB	A4,DEL4,F4,DEL2,C5,DEL2,A4,DEL2 ; ...
	DB	C5,DEL2,B4,DEL2,C5,DEL2,F4,DEL2,A4,DEL4,F4,DEL2,C5,DEL2
	DB	A4,DEL4,F4,DEL2,C5,DEL2 ; ...
	DB	E4,DEL4,F4,DEL2,D4,DEL2,C5,DEL4,B5,DEL2,G4,DEL2,E5,DEL2 ; ...
	DB	E4,DEL4,F4,DEL2,F4,DEL2,C5,DEL4,B4,DEL2,G4,DEL2 ; ...
	DB	A6,DEL4,E5,DEL2,C5,DEL2,B4,DEL2 ; ...
	DB	A4,DEL4,F4,DEL2,C5,DEL2,A4,DEL0

	DB	E5,DEL4,E5,DEL4,E5,DEL4,F5,DEL2,C5,DEL2
	DB	A4,DEL4,F4,DEL2,C5,DEL2,A4,DEL0
	DB	A5,DEL4,A4,DEL2,A4,DEL2,A5,DEL4,A5,DEL2,G5,DEL2
	DB	G5,DEL2,F5,DEL2,G5,DEL2,B4,DEL2,E5,DEL4,D5,DEL2,D5,DEL2
	DB	C5,DEL2,B4,DEL2,C5,DEL2,F4,DEL2,A4,DEL4,F4,DEL2,A4,DEL2
	DB	C5,DEL4,A4,DEL2,C5,DEL2,E5,DEL0

enotes:
	DB	00H

noteoff:
	MVI	A,40H	; disable timer
	OUT	CS
	RET

noteon:
	ORI	40H	; wave
	OUT	TMRHI
	XRA	A
	OUT	TMRLO
	MVI	A,0C0H	; start timer
	OUT	CS
	RET

; duration in A
delay:
	MVI	B,0FFh
1:	DCR	A
2:	DCR	B
	NOP
	NOP
	NOP
	NOP
	NOP
	NOP
	JNZ	2b
	CPI	00h
	JNZ	1b
	RET

	END
